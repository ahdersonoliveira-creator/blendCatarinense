<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerador de Blends - Sistema de Autentica√ß√£o</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Sistema de Gera√ß√£o de Blends de Cinzas - Carbon√≠fera Catarinense">
    
    <!-- Apple Mobile Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gerador Blend">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1087/1087815.png">
    
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #e67e22;
            --success: #27ae60;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --bg-body: #f4f7f6;
            --bg-container: #ffffff;
            --text-color: #2c3e50;
            --border-color: #ddd;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
        }

        [data-theme="black"] {
            --primary: #1a1a1a;
            --secondary: #333333;
            --accent: #8bc34a;
            --success: #2ecc71;
            --danger: #e74c3c;
            --light: #2c2c2c;
            --dark: #ecf0f1;
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --card-bg: #252525;
            --input-bg: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 50px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header img {
            max-height: 80px;
            margin-bottom: 20px;
        }

        .login-header h1 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #999;
            font-size: 14px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-login {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-login-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-login-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-login-secondary {
            background: #f0f0f0;
            color: #2c3e50;
            border: 2px solid #ddd;
        }

        .btn-login-secondary:hover {
            background: #e0e0e0;
        }

        .login-message {
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            margin-bottom: 10px;
            display: none;
        }

        .login-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .login-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .login-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .login-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* MAIN APP */
        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--bg-container);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-pmg {
            max-height: 60px;
            width: auto;
        }

        h1 {
            margin: 0;
            color: var(--primary);
            font-size: 1.8em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light);
            padding: 10px 15px;
            border-radius: 6px;
        }

        .user-badge {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .user-badge.admin {
            background: #e74c3c;
        }

        .btn-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #c0392b;
        }

        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .material-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .material-card {
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            background: var(--card-bg);
            transition: transform 0.2s;
            position: relative;
        }

        .material-card.disabled {
            opacity: 0.5;
            pointer-events: none;
            background: #eee;
        }

        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 5px;
        }

        .edit-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .slider-container { margin-top: 10px; }
        input[type="range"] { width: 100%; margin: 8px 0; }
        .percentage-display { text-align: center; font-weight: bold; font-size: 1.1em; color: var(--accent); }

        .results-section {
            background: var(--primary);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .result-item {
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
        }

        .status-ok { color: #2ecc71; font-weight: bold; }
        .status-error { color: #e74c3c; font-weight: bold; }

        .actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: #3498db; color: white; }

        /* Modais */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--bg-container);
            color: var(--text-color);
            margin: 2% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        /* Hist√≥rico */
        .history-item {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
        }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 768px) {
            .container { padding: 15px; border-radius: 0; }
            .header-wrapper { flex-direction: column; text-align: center; }
            .header-left { flex-direction: column; gap: 10px; }
            .header-right { width: 100%; justify-content: center; flex-wrap: wrap; }
            .material-grid { grid-template-columns: 1fr; }
            .config-section { grid-template-columns: 1fr; }
            .results-grid { grid-template-columns: 1fr 1fr; }
            .login-card { padding: 30px 20px; }
            h1 { font-size: 1.5em; }
            .actions { flex-direction: column; }
            .actions button { width: 100%; }
            .modal-content { width: 95%; margin: 5% auto; padding: 15px; }
            #editForm { grid-template-columns: 1fr !important; }
            input, button { font-size: 16px !important; } /* Previne zoom no iOS ao focar em inputs */
        }

        /* COMPACT LAYOUT STYLES */
        body.layout-compact .material-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        body.layout-compact .material-card { padding: 10px; }
        body.layout-compact .material-header { margin-bottom: 5px; }
        body.layout-compact .config-section { padding: 10px; gap: 10px; }
        body.layout-compact .results-section { padding: 15px; }
        body.layout-compact .result-item { padding: 8px; }
        body.layout-compact h1 { font-size: 1.2em; }
        body.layout-compact .logo-img { max-height: 40px; }

        /* PDF Styles */
        #pdf-export-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 210mm;
            height: 297mm;
            background: white;
            color: #333;
            padding: 20mm;
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
        }

        .pdf-page {
            width: 100%;
            height: 100%;
            background: white;
            color: #333;
            display: flex;
            flex-direction: column;
            page-break-after: always;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            border-bottom: 4px solid #1e3a5f;
            padding-bottom: 15px;
        }

        .pdf-header-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .pdf-header-left img {
            height: 50px;
            width: auto;
        }

        .pdf-header-title {
            font-size: 18pt;
            font-weight: bold;
            color: #1e3a5f;
            margin: 0;
        }

        .pdf-header-subtitle {
            font-size: 10pt;
            color: #666;
            margin: 3px 0 0 0;
        }

        .pdf-header-right {
            text-align: right;
            font-size: 9pt;
            color: #666;
        }

        .pdf-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .pdf-info-box {
            border-left: 5px solid #1e3a5f;
            padding-left: 15px;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .pdf-info-label {
            font-size: 9pt;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .pdf-info-value {
            font-size: 14pt;
            font-weight: bold;
            color: #1e3a5f;
        }

        .pdf-section-header {
            background-color: #1e3a5f;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 11pt;
            margin-top: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }

        .pdf-table th {
            background-color: #f5f5f5;
            color: #333;
            padding: 10px;
            font-weight: bold;
            border-bottom: 2px solid #1e3a5f;
            text-align: left;
            font-size: 9pt;
        }

        .pdf-table td {
            border-bottom: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 9pt;
        }

        .pdf-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .pdf-results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .pdf-result-box {
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
        }

        .pdf-result-label {
            font-size: 9pt;
            color: #666;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .pdf-result-value {
            font-size: 20pt;
            font-weight: bold;
            color: #1e3a5f;
            margin-bottom: 5px;
        }

        .pdf-result-status {
            font-size: 9pt;
            color: #666;
            margin-bottom: 8px;
        }

        .pdf-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 3px;
            font-size: 8pt;
            font-weight: bold;
            text-transform: uppercase;
        }

        .pdf-status-ok {
            background-color: #d4edda;
            color: #155724;
        }

        .pdf-status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .pdf-footer {
            text-align: center;
            font-size: 8pt;
            color: #999;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }

        /* DASHBOARD STYLES */
        #resumoLoteCard {
            display: none;
            background: white;
            margin-top: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
            animation: slideInUp 0.5s ease-out;
        }

        #resumoLoteCard.show {
            display: block;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5f3f 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .dashboard-header-left h2 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }

        .dashboard-titulo {
            margin: 0 0 5px 0;
            font-size: 28px;
            font-weight: bold;
        }

        .dashboard-subtitulo {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }

        .dashboard-status-badge {
            background: white;
            color: #1e3a5f;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            min-width: 150px;
        }

        .dashboard-status-badge.approved {
            background: #4CAF50;
            color: white;
        }

        .dashboard-status-badge.rejected {
            background: #F44336;
            color: white;
        }

        .dashboard-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .dashboard-section:last-of-type {
            border-bottom: none;
        }

        .dashboard-section-title {
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: bold;
            color: #1e3a5f;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #1e3a5f;
        }

        .card-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .card-label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #1e3a5f;
        }

        .card-unit {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .dashboard-quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .quality-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .quality-card:hover {
            border-color: #1e3a5f;
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.1);
        }

        .quality-card.ok {
            border-color: #4CAF50;
            background: #f1f8f4;
        }

        .quality-card.error {
            border-color: #F44336;
            background: #fef5f5;
        }

        .quality-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .quality-label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
        }

        .quality-badge {
            background: #1e3a5f;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
        }

        .quality-badge.ok {
            background: #4CAF50;
        }

        .quality-badge.error {
            background: #F44336;
        }

        .quality-value {
            font-size: 32px;
            font-weight: bold;
            color: #1e3a5f;
            margin: 10px 0;
        }

        .quality-unit {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }

        .quality-reference {
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
        }

        .quality-status {
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .dashboard-final-status {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5f3f 100%);
            color: white;
            padding: 40px;
            text-align: center;
            margin: 20px;
            border-radius: 8px;
        }

        .final-status-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .final-status-icon {
            font-size: 48px;
        }

        .final-status-text {
            font-size: 24px;
            font-weight: bold;
        }

        .dashboard-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }

        .print-btn {
            background: #2196F3;
            color: white;
        }

        .print-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .export-btn {
            background: #FF9800;
            color: white;
        }

        .export-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .close-btn {
            background: #757575;
            color: white;
        }

        .close-btn:hover {
            background: #616161;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(117, 117, 117, 0.3);
        }

        /* USERS MANAGEMENT */
        .users-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .user-card-name {
            font-weight: bold;
            font-size: 16px;
            color: var(--primary);
        }

        .user-card-role {
            font-size: 12px;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
        }

        .user-card-role.admin {
            background: #e74c3c;
        }

        .user-card-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 13px;
        }

        .user-card-actions {
            display: flex;
            gap: 10px;
        }

        .user-card-actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }

        /* Mobile Parity Styles */
        @media screen and (max-width: 768px) {
            .container { padding: 10px; margin: 0; border-radius: 0; }
            .header-wrapper { flex-direction: column; gap: 15px; text-align: center; }
            .header-actions { flex-wrap: wrap; justify-content: center; width: 100%; }
            .header-actions button { flex: 1 1 45%; font-size: 11px; padding: 10px 5px; }
            .config-section { grid-template-columns: 1fr; gap: 10px; }
            .material-grid { grid-template-columns: 1fr; }
            .results-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .result-item { padding: 10px; font-size: 0.85em; }
            .modal-content { width: 95%; margin: 5% auto; padding: 15px; }
            .quality-grid { grid-template-columns: 1fr; gap: 10px; }
            .dashboard-actions { flex-direction: column; gap: 10px; }
            .dashboard-actions button { width: 100%; }
            .actions { flex-direction: column; }
            .actions button { width: 100%; }
            input[type="number"], input[type="text"], input[type="password"] { font-size: 16px !important; } /* Previne zoom no iOS */
            .material-header span { font-size: 1.1em; }
            .mistura-row { gap: 10px; padding: 8px; }
            .mistura-item label { font-size: 0.85em; }
            .mistura-item input { width: 80px; padding: 6px; }
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            .container {
                max-width: 100%;
                margin: 0;
                padding: 0;
                border-radius: 0;
                box-shadow: none;
            }
            .header-wrapper,
            .config-section,
            #materialsContainer,
            .actions,
            .results-section,
            #editModal,
            #stockModal,
            #historyModal,
            #usersModal,
            .dashboard-actions {
                display: none !important;
            }
            #resumoLoteCard {
                background: white;
                margin: 0;
                box-shadow: none;
                page-break-after: always;
            }
            .dashboard-header {
                background: white;
                color: #1e3a5f;
                border-bottom: 3px solid #1e3a5f;
                padding: 20px;
            }
            .dashboard-titulo {
                color: #1e3a5f;
            }
            .dashboard-subtitulo {
                color: #666;
            }
            .dashboard-status-badge {
                background: white;
                color: #1e3a5f;
                border: 2px solid #1e3a5f;
            }
            .dashboard-status-badge.approved {
                background: white;
                color: #4CAF50;
                border-color: #4CAF50;
            }
            .dashboard-status-badge.rejected {
                background: white;
                color: #F44336;
                border-color: #F44336;
            }
        }
    
        /* GLOBAL BOLD */
        * { font-weight: bold !important; }
        
        /* PAINEL DE MISTURA v19 - Com suporte a modo escuro e layout profissional */
        .mistura-container { 
            margin-bottom: 20px; 
            background: var(--card-bg);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        .mistura-container.hidden { display: none; }
        
        .mistura-header {
            color: var(--text-color);
            font-size: 1.3em;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 10px;
            display: flex;
            justify-content: center;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .mistura-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .mistura-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mistura-item label { 
            font-size: 0.95em; 
            white-space: nowrap;
            color: var(--text-color);
            font-weight: 600;
        }
        .mistura-item input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            width: 100px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .mistura-item input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
        }
        
        .toggle-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .btn-toggle-mistura {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-toggle-mistura:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* Ajuste OC para incluir mistura */
        #ocContent .mistura-oc-info {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #000;
        }

    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="upload/pasted_file_eJuot8_LogoCCL1400145001Branco.png" alt="Logo Carbon√≠fera">
                <h1>Gerador de Blends</h1>
                <p>Sistema de Controle de Qualidade</p>
            </div>

            <div id="loginMessage" class="login-message"></div>

            <div class="login-tabs">
                <button class="login-tab active" onclick="switchTab('login')">Entrar</button>
                <button class="login-tab" onclick="switchTab('register')" id="registerTabBtn">Cadastrar</button>
                <button class="login-tab" onclick="importarCodigoSincronizacao()" style="font-size: 11px; color: #27ae60;">üì≤ Sincronizar</button>
            </div>

            <!-- Login Tab -->
            <div id="loginTab" class="tab-content active">
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Usu√°rio</label>
                        <input type="text" id="loginUsername" placeholder="Digite seu usu√°rio" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" placeholder="Digite sua senha" required>
                    </div>
                    <div class="login-buttons">
                        <button type="submit" class="btn-login btn-login-primary">Entrar</button>
                    </div>
                </form>
            </div>

            <!-- Register Tab -->
            <div id="registerTab" class="tab-content">
                <form class="login-form" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>Usu√°rio</label>
                        <input type="text" id="registerUsername" placeholder="Digite um usu√°rio" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="registerPassword" placeholder="Digite uma senha" required>
                    </div>
                    <div class="form-group">
                        <label>Confirmar Senha</label>
                        <input type="password" id="registerPasswordConfirm" placeholder="Confirme a senha" required>
                    </div>
                    <div class="login-buttons">
                        <button type="submit" class="btn-login btn-login-primary">Cadastrar</button>
                        <button type="button" class="btn-login btn-login-secondary" onclick="switchTab('login')">Voltar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appScreen" class="app-container">
        <div class="container">
            <div class="header-wrapper">
                <div class="header-left">
                    <img src="upload/pasted_file_eJuot8_LogoCCL1400145001Branco.png" alt="Logo Carbon√≠fera" class="logo-img">
                    <h1>GERADOR DE BLENDS</h1>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span id="currentUserDisplay">-</span>
                        <span class="user-badge" id="userRoleBadge">-</span>
                    </div>
                    <button class="btn-info" id="usersManagementBtn" onclick="openUsersManagement()" style="display:none">üë• USU√ÅRIOS</button>
                    <button class="btn-info" onclick="openHistory()">üìú Hist√≥rico</button>
                    <button class="btn-info" id="themeToggle" onclick="toggleTheme()">üåô Tema Black</button>
                    <button class="btn-info" id="layoutToggle" onclick="toggleLayout()">üì± Layout Compacto</button>
                    <button class="btn-success" onclick="gerarLinkCompartilhamento()" title="Compartilhar usu√°rios via link">üîó Compartilhar App</button>
                    <button class="btn-logout" onclick="handleLogout()">üö™ Sair</button>
                </div>
            </div>

            <div class="config-section">
                <div class="input-group">
                    <label>N√∫mero do Lote</label>
                    <input type="text" id="numeroLote" placeholder="Ex: LT-2026-001" oninput="saveData()">
                </div>
                <div class="input-group">
                    <label>Volume Total (Ton)</label>
                    <input type="number" id="totalToneladas" value="1000" oninput="updateResults()">
                </div>
                <div class="input-group">
                    <label>Peso p/ Carreta (t)</label>
                    <input type="number" id="pesoCarreta" value="20" oninput="updateResults()">
                </div>
                <div class="input-group">
                    <label>Meta PCS M√≠nimo</label>
                    <input type="number" id="metaPcsMin" value="4500" oninput="saveData()">
                </div>
            </div>

            
            <div class="toggle-container" style="gap: 10px;">
                <button id="btnOcultarZerados" class="btn-toggle-mistura" onclick="toggleOcultarZerados()" style="background-color: #7f8c8d;">OCULTAR ZERADOS</button>
                <button id="btnToggleMistura" class="btn-toggle-mistura" onclick="toggleMistura()">OCULTAR MISTURA</button>
            </div>
            <div id="misturaContainer" class="mistura-container">
                <div class="mistura-header">MISTURA</div>
                
                <div class="mistura-row">
                    <div class="mistura-item">
                        <label>1¬∫ Lote :</label>
                        <input type="text" id="misturaLoteInfo" value="25 cargas" oninput="saveData()">
                    </div>
                </div>
                
                <div class="mistura-row">
                    <div class="mistura-item">
                        <label>Carv√£o bonito :</label>
                        <input type="text" id="misturaBonitoCargas" value="20 cargas" oninput="saveData()">
                    </div>
                    <div class="mistura-item">
                        <label>: Usar</label>
                        <input type="text" id="misturaBonitoConchadas" value="02" oninput="saveData()">
                        <label>conchadas de especial</label>
                    </div>
                </div>
                
                <div class="mistura-row">
                    <div class="mistura-item">
                        <label>Mistura de Finos + Especial :</label>
                        <input type="text" id="misturaFinosCargas" value="05 cargas" oninput="saveData()">
                    </div>
                    <div class="mistura-item">
                        <label>: Usar</label>
                        <input type="text" id="misturaFinosConchadas" value="02" oninput="saveData()">
                        <label>de Finos e</label>
                        <input type="text" id="misturaEspecialConchadas" value="01" oninput="saveData()">
                        <label>de Especial por carreta</label>
                    </div>
                </div>
            
                <div class="mistura-row">
                    <div class="mistura-item" style="width: 100%;">
                        <label>Observa√ß√µes:</label>
                        <input type="text" id="misturaObs" placeholder="Digite instru√ß√µes de carregamento..." oninput="saveData()" style="width: 100%; font-weight: bold !important;">
                    </div>
                </div>
            </div>

            <div id="materialsContainer" class="material-grid"></div>

            <div class="results-section">
                <h2>üìä Dashboard de Qualidade</h2>
                <div id="resultadoBlend" class="results-grid"></div>
            </div>

            <div class="actions">
                <button class="btn-primary" onclick="autoBlend()">ü§ñ AUTO BLEND (43-44% CINZA)</button>
                <button class="btn-info" onclick="autoBlend(true)" style="background-color: #3498db;">üí∞ BLEND MAIS RENT√ÅVEL</button>
                <button class="btn-success" onclick="saveCurrentLot()">üíæ SALVAR LOTE</button>
                <button class="btn-secondary" onclick="openStockManager()">üì¶ ESTOQUE</button>
                <button class="btn-danger" id="pdfButton" onclick="generatePDF()" style="display:none">üìÑ GERAR PDF</button>
            </div>

            <!-- Dashboard de Resumo do Lote -->
            <div id="resumoLoteCard">
                <div class="dashboard-header">
                    <div class="dashboard-header-left">
                        <h2 class="dashboard-titulo">üìä RESUMO DO LOTE</h2>
                        <p class="dashboard-subtitulo" id="resumoDataHora">-</p>
                    </div>
                    <div class="dashboard-status-badge" id="statusBadge">-</div>
                </div>

                <div class="dashboard-section">
                    <h3 class="dashboard-section-title">üì¶ Informa√ß√µes do Lote</h3>
                    <div class="dashboard-info-grid">
                        <div class="dashboard-card">
                            <div class="card-icon">üìã</div>
                            <div class="card-label">N√∫mero do Lote</div>
                            <div class="card-value" id="resumoNumeroLote">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-icon">‚öñÔ∏è</div>
                            <div class="card-label">Quantidade Total</div>
                            <div class="card-value" id="resumoQuantidade">-</div>
                            <div class="card-unit">toneladas</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-icon">üöö</div>
                            <div class="card-label">Quantidade de Carretas</div>
                            <div class="card-value" id="resumoCarretas">-</div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-icon">üìä</div>
                            <div class="card-label">M√©dia por Carreta</div>
                            <div class="card-value" id="resumoMedia">-</div>
                            <div class="card-unit">toneladas</div>
                        </div>
                        <div class="dashboard-card" style="border-left: 4px solid var(--accent);">
                            <div class="card-icon">üí∞</div>
                            <div class="card-label">Custo M√©dio</div>
                            <div class="card-value" id="resumoCusto">-</div>
                            <div class="card-unit">R$ / tonelada</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section">
                    <h3 class="dashboard-section-title">üî¨ An√°lise de Qualidade</h3>
                    <div class="dashboard-quality-grid">
                        <div class="quality-card" id="pcsCard">
                            <div class="quality-header">
                                <span class="quality-label">Poder Cal√≥rico (PCS)</span>
                                <span class="quality-badge" id="pcsBadge">-</span>
                            </div>
                            <div class="quality-value" id="resumoPCS">-</div>
                            <div class="quality-unit">kcal/kg</div>
                            <div class="quality-reference">Ref: ‚â• 4500</div>
                            <div class="quality-status" id="resumoStatusPCS">-</div>
                        </div>

                        <div class="quality-card" id="cinzaCard">
                            <div class="quality-header">
                                <span class="quality-label">Teor de Cinzas</span>
                                <span class="quality-badge" id="cinzaBadge">-</span>
                            </div>
                            <div class="quality-value" id="resumoCinza">-</div>
                            <div class="quality-unit">%</div>
                            <div class="quality-reference">Ref: ‚â§ 44%</div>
                            <div class="quality-status" id="resumoStatusCinza">-</div>
                        </div>

                        <div class="quality-card" id="umidadeCard">
                            <div class="quality-header">
                                <span class="quality-label">Umidade</span>
                                <span class="quality-badge" id="umidadeBadge">-</span>
                            </div>
                            <div class="quality-value" id="resumoUmidade">-</div>
                            <div class="quality-unit">%</div>
                            <div class="quality-reference">Ref: ‚â§ 10%</div>
                            <div class="quality-status" id="resumoStatusUmidade">-</div>
                        </div>

                        <div class="quality-card" id="enxofreCard">
                            <div class="quality-header">
                                <span class="quality-label">Enxofre</span>
                                <span class="quality-badge" id="enxofreBadge">-</span>
                            </div>
                            <div class="quality-value" id="resumoEnxofre">-</div>
                            <div class="quality-unit">%</div>
                            <div class="quality-reference">Ref: ‚â§ 2.30%</div>
                            <div class="quality-status" id="resumoStatusEnxofre">-</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-final-status">
                    <div class="final-status-content">
                        <div class="final-status-icon" id="finalStatusIcon">-</div>
                        <div class="final-status-text" id="resumoQualidade">-</div>
                    </div>
                </div>

                <div class="dashboard-actions">
                    <button class="action-btn print-btn" onclick="imprimirResumo()">üñ®Ô∏è IMPRIMIR</button>
                    <button class="action-btn print-btn" onclick="gerarOC()" style="background-color: #e67e22;">üöú GERAR OC</button>
                    <button class="action-btn export-btn" onclick="exportarJSON()">üì• EXPORTAR JSON</button>
                    <button class="action-btn close-btn" onclick="fecharResumo()">‚úï FECHAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Material</h2>
                <button class="close-modal" onclick="closeEditModal()">‚úï</button>
            </div>
            <div id="editForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="input-group"><label>Nome</label><input type="text" id="editNome"></div>
                <div class="input-group"><label>PCS</label><input type="number" id="editPcs"></div>
                <div class="input-group"><label>Cinzas (%)</label><input type="number" step="0.01" id="editCinzas"></div>
                <div class="input-group"><label>Umidade (%)</label><input type="number" step="0.01" id="editUmidade"></div>
                <div class="input-group"><label>Enxofre (%)</label><input type="number" step="0.01" id="editEnxofre"></div>
                <div class="input-group"><label>Estoque (t)</label><input type="number" step="0.01" id="editEstoque"></div>
                <div class="input-group"><label>Custo Fixo (R$/t)</label><input type="number" step="0.01" id="editCustoFixo"></div>
                <div class="input-group"><label>Custo Vari√°vel (R$/t)</label><input type="number" step="0.01" id="editCustoVariavel"></div>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content: flex-end; align-items: center;">
                <button id="btnToggleAutoCalc" class="btn-primary" onclick="toggleAutoCalculate()" style="background: var(--accent); font-size: 0.85em;">‚ö° C√°lculo: ON</button>
                <button class="btn-success" onclick="saveMaterialEdit()">Salvar</button>
                <button class="btn-secondary" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="stockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gerenciar Estoque</h2>
                <button class="close-modal" onclick="document.getElementById('stockModal').style.display='none'">‚úï</button>
            </div>
            <div id="stockList"></div>
            <button class="btn-secondary" onclick="document.getElementById('stockModal').style.display='none'" style="margin-top:20px;">Fechar</button>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Hist√≥rico de Lotes</h2>
                <button class="close-modal" onclick="document.getElementById('historyModal').style.display='none'">‚úï</button>
            </div>
            <div id="historyList"></div>
            <button class="btn-danger" onclick="clearHistory()" style="margin-top:20px; margin-right:10px;">üóëÔ∏è Excluir Tudo</button>
            <button class="btn-secondary" onclick="document.getElementById('historyModal').style.display='none'" style="margin-top:20px;">Fechar</button>
        </div>
    </div>

    <div id="usersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gerenciar Usu√°rios</h2>
                <button class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">‚úï</button>
            </div>
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba;">
                <p style="width: 100%; margin-bottom: 10px; font-size: 0.9em; color: #856404;"><b>üí° Dica de Sincroniza√ß√£o:</b> Para que outros computadores consigam logar, exporte os usu√°rios aqui e importe no outro computador.</p>
                <button class="btn-success" onclick="openNewUserForm()">‚ûï Novo Usu√°rio</button>
                <button class="btn-primary" onclick="exportUsers()">üì§ Exportar Lista de Usu√°rios</button>
                <button class="btn-secondary" onclick="document.getElementById('importUsersInput').click()">üì• Importar Lista de Usu√°rios</button>
                <input type="file" id="importUsersInput" style="display: none;" accept=".json" onchange="importUsers(event)">
            </div>
            <div id="newUserForm" style="display:none; background: var(--light); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>Cadastrar Novo Usu√°rio</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div class="input-group">
                        <label>Usu√°rio</label>
                        <input type="text" id="newUsername" placeholder="Digite o usu√°rio">
                    </div>
                    <div class="input-group">
                        <label>Senha</label>
                        <input type="password" id="newPassword" placeholder="Digite a senha">
                    </div>
                    <div class="input-group">
                        <label>Tipo de Usu√°rio</label>
                        <select id="newUserRole" style="padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: #f9f9f9;">
                            <option value="false">Usu√°rio Normal</option>
                            <option value="true">Administrador</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn-success" onclick="createNewUser()">Criar Usu√°rio</button>
                    <button class="btn-secondary" onclick="closeNewUserForm()">Cancelar</button>
                </div>
            </div>
            <div id="usersList" class="users-list"></div>
            <button class="btn-secondary" onclick="document.getElementById('usersModal').style.display='none'" style="margin-top:20px;">Fechar</button>
        </div>
    </div>

    <!-- Hidden Container for PDF Export -->
    <div id="pdf-export-container"></div>

    <script>
        // ===== AUTHENTICATION SYSTEM =====
        let users = [];
        let currentUser = null;
        let currentTheme = 'light';

        function initAuth() {
            checkSync();
            const savedUsers = localStorage.getItem('blendUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                // Create default admin user
                users = [
                    { username: 'Anderson', password: '200678', isAdmin: true }
                ];
                saveUsers();
            }

            const loggedInUser = sessionStorage.getItem('currentUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                showApp();
            } else {
                showLogin();
                // Pequeno aviso para novos usu√°rios em outros computadores
                if (!savedUsers) {
                    console.log("Sistema inicializado em novo dispositivo. Use o usu√°rio padr√£o Anderson para importar outros usu√°rios se necess√°rio.");
                }
            }
        }

        function saveUsers() {
            localStorage.setItem('blendUsers', JSON.stringify(users));
        }

        function switchTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.login-tab')[0].classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                document.querySelectorAll('.login-tab')[1].classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const messageEl = document.getElementById('loginMessage');

            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = { username: user.username, isAdmin: user.isAdmin };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                messageEl.className = 'login-message success';
                messageEl.innerText = 'Login realizado com sucesso!';
                setTimeout(() => showApp(), 500);
            } else {
                messageEl.className = 'login-message error';
                messageEl.innerText = 'Usu√°rio ou senha incorretos!';
                document.getElementById('loginPassword').value = '';
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const messageEl = document.getElementById('loginMessage');

            if (password !== passwordConfirm) {
                messageEl.className = 'login-message error';
                messageEl.innerText = 'As senhas n√£o coincidem!';
                return;
            }

            if (users.find(u => u.username === username)) {
                messageEl.className = 'login-message error';
                messageEl.innerText = 'Este usu√°rio j√° existe!';
                return;
            }

            // Solicitar confirma√ß√£o do administrador
            const adminUser = prompt('Para confirmar o cadastro, digite o usu√°rio do administrador:');
            if (adminUser !== 'Anderson') {
                messageEl.className = 'login-message error';
                messageEl.innerText = 'Usu√°rio do administrador incorreto! Cadastro cancelado.';
                return;
            }

            const adminPassword = prompt('Digite a senha do administrador:');
            if (adminPassword !== '200678') {
                messageEl.className = 'login-message error';
                messageEl.innerText = 'Senha do administrador incorreta! Cadastro cancelado.';
                return;
            }

            users.push({ username, password, isAdmin: false });
            saveUsers();
            messageEl.className = 'login-message success';
            messageEl.innerText = 'Usu√°rio cadastrado com sucesso! Fa√ßa login.';
            
            setTimeout(() => {
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerPasswordConfirm').value = '';
                switchTab('login');
            }, 1000);
        }

        function handleLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                sessionStorage.removeItem('currentUser');
                currentUser = null;
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appScreen').classList.remove('active');
            document.getElementById('loginMessage').className = 'login-message';
            document.getElementById('loginMessage').innerText = '';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').classList.add('active');
            
            // Update user display
            document.getElementById('currentUserDisplay').innerText = currentUser.username;
            const badge = document.getElementById('userRoleBadge');
            if (currentUser.isAdmin) {
                badge.innerText = 'üëë Administrador';
                badge.classList.add('admin');
                // Apenas o Anderson v√™ o bot√£o de gest√£o de usu√°rios
                if (currentUser.username === 'Anderson') {
                    document.getElementById('usersManagementBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('usersManagementBtn').style.display = 'none';
                }
            } else {
                badge.innerText = 'Usu√°rio';
                document.getElementById('usersManagementBtn').style.display = 'none';
            }

            init();
            initLayout();
        }

        function openUsersManagement() {
            if (currentUser.username !== 'Anderson') {
                alert('Apenas o administrador Anderson pode gerenciar usu√°rios!');
                return;
            }
            loadUsersList();
            document.getElementById('usersModal').style.display = 'block';
        }

        function exportUsers() {
            const dataStr = JSON.stringify(users, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `usuarios_blend_${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Lista de usu√°rios exportada com sucesso! Compartilhe este arquivo com outros usu√°rios.');
        }

        function importUsers(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedUsers = JSON.parse(e.target.result);
                    if (Array.isArray(importedUsers)) {
                        // Mesclar usu√°rios sem duplicar
                        importedUsers.forEach(impUser => {
                            if (!users.find(u => u.username === impUser.username)) {
                                users.push(impUser);
                            }
                        });
                        saveUsers();
                        loadUsersList();
                        alert('Usu√°rios importados com sucesso!');
                    } else {
                        alert('Arquivo de usu√°rios inv√°lido!');
                    }
                } catch (err) {
                    alert('Erro ao ler o arquivo de usu√°rios!');
                }
                event.target.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        function loadUsersList() {
            const list = document.getElementById('usersList');
            list.innerHTML = '';
            
            users.forEach((user, idx) => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `
                    <div class="user-card-header">
                        <div>
                            <div class="user-card-name">${user.username}</div>
                        </div>
                        <span class="user-card-role ${user.isAdmin ? 'admin' : ''}">
                            ${user.isAdmin ? 'üëë Admin' : 'üë§ Usu√°rio'}
                        </span>
                    </div>
                    <div class="user-card-info">
                        <span><strong>Usu√°rio:</strong> ${user.username}</span>
                    </div>
                    <div class="user-card-actions">
                        ${user.username !== 'Anderson' ? `
                            <button class="btn-danger" onclick="deleteUser(${idx})">üóëÔ∏è Deletar</button>
                        ` : `
                            <span style="text-align: center; color: #999;">Usu√°rio padr√£o (n√£o pode ser deletado)</span>
                        `}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function openNewUserForm() {
            document.getElementById('newUserForm').style.display = 'block';
        }

        function closeNewUserForm() {
            document.getElementById('newUserForm').style.display = 'none';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
        }

        function createNewUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const isAdmin = document.getElementById('newUserRole').value === 'true';

            if (!username || !password) {
                alert('Preencha todos os campos!');
                return;
            }

            if (users.find(u => u.username === username)) {
                alert('Este usu√°rio j√° existe!');
                return;
            }

            users.push({ username, password, isAdmin: isAdmin });
            saveUsers();
            alert(`Usu√°rio "${username}" criado com sucesso como ${isAdmin ? 'Administrador' : 'Usu√°rio Normal'}!`);
            closeNewUserForm();
            loadUsersList();
        }

        function deleteUser(idx) {
            if (users[idx].username === 'Anderson') {
                alert('N√£o √© poss√≠vel deletar o usu√°rio padr√£o!');
                return;
            }

            if (confirm(`Tem certeza que deseja deletar o usu√°rio "${users[idx].username}"?`)) {
                users.splice(idx, 1);
                saveUsers();
                loadUsersList();
            }
        }

        // ===== BLEND SYSTEM =====
        let materials = [
            { nome: "Carv√£o bonito", pcs: 4350, cinzas: 47, umidade: 5, enxofre: 2.4, estoque: 1000, custoFixo: 0, custoVariavel: 0 },
            { nome: "Finos Bonito", pcs: 3310, cinzas: 58, umidade: 18, enxofre: 2.4, estoque: 1000, custoFixo: 0, custoVariavel: 0 },
            { nome: "Finos Bonito produ√ß√£o", pcs: 3310, cinzas: 58, umidade: 18, enxofre: 2.4, estoque: 1000, custoFixo: 0, custoVariavel: 0 },
            { nome: "Vegetal", pcs: 5500, cinzas: 18, umidade: 18, enxofre: 0, estoque: 1000, custoFixo: 0, custoVariavel: 0 },
            { nome: "Especial produ√ß√£o", pcs: 7000, cinzas: 8, umidade: 6, enxofre: 1.14, estoque: 1500, custoFixo: 0, custoVariavel: 0 },
            { nome: "Barro Branco", pcs: 6000, cinzas: 44, umidade: 6, enxofre: 2.4, estoque: 4000, custoFixo: 0, custoVariavel: 0 },
            { nome: "P√≥ de Serra LBV", pcs: 8000, cinzas: 3, umidade: 2, enxofre: 0.5, estoque: 800, custoFixo: 0, custoVariavel: 0 },
            { nome: "COQUE VERDE", pcs: 1800, cinzas: 1, umidade: 6, enxofre: 5.5, estoque: 1200, custoFixo: 0, custoVariavel: 0 },
            { nome: "REJEITO LBV", pcs: 4700, cinzas: 60, umidade: 15, enxofre: 3.5, estoque: 6000, custoFixo: 0, custoVariavel: 0 },
            { nome: "CE 4700 - Finos", pcs: 4200, cinzas: 35, umidade: 2, enxofre: 1.0, estoque: 2500, custoFixo: 0, custoVariavel: 0 },
            { nome: "CE 4200 - Grado", pcs: 4500, cinzas: 41, umidade: 15, enxofre: 1.0, estoque: 1800, custoFixo: 0, custoVariavel: 0 },
            { nome: "CE 4500 - Granulado Copelmi", pcs: 4865, cinzas: 40, umidade: 15, enxofre: 1.0, estoque: 3000, custoFixo: 0, custoVariavel: 0 },
            { nome: "Finos Carv√£o Vegetal", pcs: 5000, cinzas: 18, umidade: 25, enxofre: 0.02, estoque: 500, custoFixo: 0, custoVariavel: 0 },
            { nome: "Rejeito LNH - Relavado", pcs: 2900, cinzas: 62, umidade: 6, enxofre: 3.5, estoque: 4500, custoFixo: 0, custoVariavel: 0 },
            { nome: "Finos Barro Branco", pcs: 2820, cinzas: 63, umidade: 14, enxofre: 2.4, estoque: 3200, custoFixo: 0, custoVariavel: 0 },
            { nome: "Carv√£o Barro Branco", pcs: 4886, cinzas: 39.73, umidade: 10, enxofre: 1.58, estoque: 1000, custoFixo: 0, custoVariavel: 0 }
        ];
        let percentages = new Array(materials.length).fill(0);
        let history = [];
        let currentEditIndex = -1;
        let autoCalculateEnabled = true;
        let ultimoResumo = null;
        let ocultarZerados = false;

        
        let misturaVisivel = true;
        function toggleMistura() {
            misturaVisivel = !misturaVisivel;
            const container = document.getElementById('misturaContainer');
            const btn = document.getElementById('btnToggleMistura');
            if (misturaVisivel) {
                container.classList.remove('hidden');
                btn.innerText = 'OCULTAR MISTURA';
            } else {
                container.classList.add('hidden');
                btn.innerText = 'MOSTRAR MISTURA';
            }
            saveData();
        }

        function init() {
            const savedData = localStorage.getItem('blendDataPro');
            if (savedData) {
                const data = JSON.parse(savedData);
                materials = data.materials || materials;
                percentages = data.percentages || percentages;
                history = data.history || [];
                document.getElementById('totalToneladas').value = data.totalTon || 1000;
                document.getElementById('pesoCarreta').value = data.pesoCarreta || 20;
                document.getElementById('metaPcsMin').value = data.metaPcsMin || 4500;
                document.getElementById('numeroLote').value = data.numeroLote || '';
                if(data.misturaVisivel === false) toggleMistura();
                if(data.misturaLoteInfo) document.getElementById('misturaLoteInfo').value = data.misturaLoteInfo;
                if(data.misturaBonitoCargas) document.getElementById('misturaBonitoCargas').value = data.misturaBonitoCargas;
                if(data.misturaBonitoConchadas) document.getElementById('misturaBonitoConchadas').value = data.misturaBonitoConchadas;
                if(data.misturaFinosCargas) document.getElementById('misturaFinosCargas').value = data.misturaFinosCargas;
                if(data.misturaFinosConchadas) document.getElementById('misturaFinosConchadas').value = data.misturaFinosConchadas;
                if(data.misturaEspecialConchadas) document.getElementById('misturaEspecialConchadas').value = data.misturaEspecialConchadas;
                if(data.misturaObs) document.getElementById('misturaObs').value = data.misturaObs;
                if(data.theme) setTheme(data.theme);
                if(data.ocultarZerados) {
                    ocultarZerados = data.ocultarZerados;
                    document.getElementById('btnOcultarZerados').innerText = 'MOSTRAR ZERADOS';
                }
            }
            renderMaterials();
            updateResults();
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeToggle').innerText = theme === 'black' ? '‚òÄÔ∏è Tema Light' : 'üåô Tema Black';
            saveData();
        }

        function toggleTheme() { setTheme(currentTheme === 'light' ? 'black' : 'light'); }

        function toggleLayout() {
            const body = document.body;
            const btn = document.getElementById('layoutToggle');
            if (body.classList.contains('layout-compact')) {
                body.classList.remove('layout-compact');
                btn.innerText = 'üì± Layout Compacto';
                localStorage.setItem('blendLayout', 'normal');
            } else {
                body.classList.add('layout-compact');
                btn.innerText = 'üñ•Ô∏è Layout Normal';
                localStorage.setItem('blendLayout', 'compact');
            }
        }

        function initLayout() {
            const savedLayout = localStorage.getItem('blendLayout');
            if (savedLayout === 'compact') {
                document.body.classList.add('layout-compact');
                document.getElementById('layoutToggle').innerText = 'üñ•Ô∏è Layout Normal';
            }
        }

        function toggleOcultarZerados() {
            ocultarZerados = !ocultarZerados;
            const btn = document.getElementById('btnOcultarZerados');
            btn.innerText = ocultarZerados ? 'MOSTRAR ZERADOS' : 'OCULTAR ZERADOS';
            renderMaterials();
            saveData();
        }

        function renderMaterials() {
            const container = document.getElementById('materialsContainer');
            container.innerHTML = '';
            materials.forEach((mat, idx) => {
                const isDisabled = mat.estoque <= 0;
                if (ocultarZerados && isDisabled) return;

                const card = document.createElement('div');
                card.className = `material-card ${isDisabled ? 'disabled' : ''}`;
                const custoTotal = (parseFloat(mat.custoFixo || 0) + parseFloat(mat.custoVariavel || 0));
                card.innerHTML = `
                    <div class="material-header">
                        <span style="font-weight:bold">${mat.nome}</span>
                        <button class="edit-btn" onclick="openEditModal(${idx})">‚úèÔ∏è</button>
                    </div>
                    <div style="font-size:0.85em; display:grid; grid-template-columns:1fr 1fr; gap:5px">
                        <span>PCS: <b>${mat.pcs}</b></span>
                        <span>Cinza: <b>${mat.cinzas}%</b></span>
                        <span>Umid: <b>${mat.umidade}%</b></span>
                        <span>Enx: <b>${mat.enxofre}%</b></span>
                        <span style="grid-column: span 2; color: var(--accent)">Custo: <b>R$ ${custoTotal.toFixed(2)}/t</b></span>
                    </div>
                    <div style="margin-top:8px; font-weight:bold; color:${isDisabled?'var(--danger)':'var(--success)'}">
                        Estoque: <span id="stock_rem_${idx}">${mat.estoque.toFixed(1)} t</span>
                    </div>
                    <div class="slider-container">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <input type="range" min="0" max="100" step="0.1" value="${percentages[idx]}" id="slider${idx}"
                                   oninput="updatePercentage(${idx}, this.value)" ${isDisabled ? 'disabled' : ''} style="flex: 1;">
                            <input type="number" min="0" max="100" step="0.1" value="${parseFloat(percentages[idx]).toFixed(1)}" 
                                   id="percInput${idx}" oninput="updatePercentage(${idx}, this.value)" 
                                   ${isDisabled ? 'disabled' : ''} 
                                   style="width: 70px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; font-weight: bold; text-align: center;">
                        </div>
                        <div class="percentage-display" id="percDisplay${idx}" style="display:none">${parseFloat(percentages[idx]).toFixed(2)}%</div>
                        <div style="text-align:center; font-size:0.8em; opacity:0.7" id="qty${idx}">0.00 t</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updatePercentage(idx, val) {
            let numVal = parseFloat(val) || 0;
            if (numVal < 0) numVal = 0;
            if (numVal > 100) numVal = 100;
            
            percentages[idx] = numVal;
            
            // Sincronizar Slider e Input Num√©rico
            const slider = document.getElementById(`slider${idx}`);
            const input = document.getElementById(`percInput${idx}`);
            const display = document.getElementById(`percDisplay${idx}`);
            
            if (slider) slider.value = numVal;
            if (input && document.activeElement !== input) input.value = numVal.toFixed(1);
            if (display) display.innerText = numVal.toFixed(2) + '%';
            
            updateResults();
            saveData();
        }

        function calculateMetrics(percs, totalT) {
            let total_ton_bs = 0, s_cz = 0, s_enx = 0, s_umid = 0, s_custo = 0, s_pcs = 0;
            const totalP = percs.reduce((a,b)=>a+b,0);
            
            if (totalP <= 0) {
                return { pcs: 0, cinza: 0, umid: 0, enxofre: 0, soma: 0, custo: 0 };
            }

            percs.forEach((p, idx) => {
                const ton_bu = totalT * (p/100);
                const ton_bs = ton_bu * (1 - (materials[idx].umidade/100));
                total_ton_bs += ton_bs;
                s_cz += materials[idx].cinzas * ton_bs;
                s_enx += materials[idx].enxofre * ton_bs;
                s_pcs += materials[idx].pcs * ton_bs;
                s_umid += materials[idx].umidade * (p/100);
                s_custo += ((parseFloat(materials[idx].custoFixo || 0) + parseFloat(materials[idx].custoVariavel || 0)) * ton_bu);
            });

            const cz_f = total_ton_bs > 0 ? (s_cz / total_ton_bs) : 0;
            const enx_f = total_ton_bs > 0 ? (s_enx / total_ton_bs) : 0;
            const pcs_f = total_ton_bs > 0 ? (s_pcs / total_ton_bs) : 0;
            const umid_f = totalP > 0 ? (s_umid / (totalP/100)) : 0;
            const custo_f = totalT > 0 ? (s_custo / totalT) : 0;
            return { pcs: pcs_f, cinza: cz_f, umid: umid_f, enxofre: enx_f, soma: totalP, custo: custo_f };
        }

        function updateResults() {
            const total = parseFloat(document.getElementById('totalToneladas').value) || 0;
            const pesoCarreta = parseFloat(document.getElementById('pesoCarreta').value) || 20;
            const m = calculateMetrics(percentages, total);
            
            materials.forEach((mat, idx) => {
                const ton_bu = total * (percentages[idx]/100);
                if(document.getElementById(`qty${idx}`)) document.getElementById(`qty${idx}`).innerText = ton_bu.toFixed(2) + ' t';
                const stockRem = (mat.estoque - ton_bu).toFixed(1);
                const stockEl = document.getElementById(`stock_rem_${idx}`);
                if (stockEl) {
                    stockEl.innerText = stockRem + ' t';
                    stockEl.style.color = stockRem < 0 ? 'var(--danger)' : 'var(--success)';
                }
            });

            const pcsOk = m.pcs >= 4500;
            const czOk = m.cinza <= 44;
            const umidOk = m.umid <= 10;
            const enxOk = m.enxofre <= 2.30;
            const pOk = Math.abs(m.soma - 100) < 0.01;
            const allOk = pcsOk && czOk && umidOk && enxOk && pOk;

            const res = document.getElementById('resultadoBlend');
            res.innerHTML = `
                <div class="result-item"><span>PCS Ponderado</span><br><span class="${pcsOk?'status-ok':'status-error'}">${m.pcs.toFixed(0)} kcal ${pcsOk?'‚úì':'‚úó'}</span></div>
                <div class="result-item"><span>Teor de Cinzas</span><br><span class="${czOk?'status-ok':'status-error'}">${m.cinza.toFixed(2)}% ${czOk?'‚úì':'‚úó'}</span></div>
                <div class="result-item"><span>Umidade M√©dia</span><br><span class="${umidOk?'status-ok':'status-error'}">${m.umid.toFixed(2)}% ${umidOk?'‚úì':'‚úó'}</span></div>
                <div class="result-item"><span>Enxofre M√©dio</span><br><span class="${enxOk?'status-ok':'status-error'}">${m.enxofre.toFixed(2)}% ${enxOk?'‚úì':'‚úó'}</span></div>
                <div class="result-item"><span>Soma das %</span><br><span class="${pOk?'status-ok':'status-error'}">${m.soma.toFixed(1)}% ${pOk?'‚úì':'‚úó'}</span></div>
                <div class="result-item"><span>Qtd. Carretas</span><br><span style="font-weight:bold; color:var(--accent)">${(total / pesoCarreta).toFixed(1)}</span></div>
                <div class="result-item" style="grid-column: span 2"><span>Custo M√©dio Blend</span><br><span style="font-weight:bold; color:var(--accent)">R$ ${m.custo.toFixed(2)} / t</span></div>
                <div style="grid-column: 1 / -1; font-size: 1.3em; margin-top: 10px; color: ${allOk?'#2ecc71':'#e74c3c'}">
                    ${allOk?'‚úÖ LOTE APROVADO':'‚ùå LOTE REPROVADO'}
                </div>
            `;
        }

        function autoBlend(optimizeForCost = false) {
            const metaPcs = parseFloat(document.getElementById('metaPcsMin').value) || 4500;
            let bestConfig = new Array(materials.length).fill(0);
            let minCost = Infinity;
            let found = false;
            const iterations = optimizeForCost ? 30000 : 15000;

            for(let i=0; i<iterations; i++) {
                let temp = new Array(materials.length).fill(0);
                let avail = materials.map((m, idx) => m.estoque > 0 ? idx : -1).filter(idx => idx !== -1);
                if(avail.length === 0) break;

                let rem = 100;
                while(rem > 0 && avail.length > 0) {
                    let idx = avail[Math.floor(Math.random() * avail.length)];
                    let val = Math.min(rem, Math.floor(Math.random() * 50));
                    temp[idx] += val;
                    rem -= val;
                    if(rem < 1) { temp[idx] += rem; rem = 0; }
                }

                const m = calculateMetrics(temp, 1000);
                // Crit√©rios originais de aprova√ß√£o para o Auto Blend
                const approved = m.pcs >= metaPcs && m.cinza <= 44;
                
                if(approved) {
                    if (optimizeForCost) {
                        if (m.custo < minCost) {
                            minCost = m.custo;
                            bestConfig = [...temp];
                            found = true;
                        }
                    } else {
                        // Busca o blend ideal na faixa de cinza desejada
                        if(m.cinza >= 43 && m.cinza <= 44) {
                            bestConfig = temp;
                            found = true;
                            break;
                        }
                    }
                }
            }

            if(!found) alert("N√£o foi poss√≠vel encontrar um blend que atenda aos requisitos de qualidade. Tente ajustar os estoques ou as metas.");
            else {
                percentages = bestConfig;
                renderMaterials();
                updateResults();
                saveData();
                if(optimizeForCost) alert("Otimiza√ß√£o conclu√≠da! Blend mais rent√°vel encontrado com custo de R$ " + minCost.toFixed(2) + "/t");
            }
        }

        function checkApprovalStatus() {
            const m = calculateMetrics(percentages, document.getElementById('totalToneladas').value);
            const pcsOk = m.pcs >= 4500;
            const cinzaOk = m.cinza <= 44;
            const umidOk = m.umid <= 10;
            const enxOk = m.enxofre <= 2.30;
            return pcsOk && cinzaOk && umidOk && enxOk;
        }

        function saveCurrentLot() {
            const lote = document.getElementById('numeroLote').value || 'Lote_' + Date.now();
            const totalTon = parseFloat(document.getElementById('totalToneladas').value) || 1000;
            const pesoCarreta = parseFloat(document.getElementById('pesoCarreta').value) || 20;
            const metrics = calculateMetrics(percentages, totalTon);
            const isApproved = checkApprovalStatus();
            
            history.unshift({
                lote, data: new Date().toLocaleString(), metrics, percentages: [...percentages], totalTon: totalTon, approved: isApproved
            });
            saveData();
            
            mostrarResumoLote(lote, totalTon, pesoCarreta, metrics, isApproved);
            showPDFButton();
        }

        function mostrarResumoLote(lote, totalTon, pesoCarreta, metrics, isApproved) {
            const now = new Date();
            const qtdCarretas = (totalTon / pesoCarreta).toFixed(1);
            const mediaCarreta = (totalTon / qtdCarretas).toFixed(2);
            
            const pcsOk = metrics.pcs >= 4500;
            const czOk = metrics.cinza <= 44;
            const umidOk = metrics.umid <= 10;
            const enxOk = metrics.enxofre <= 2.30;
            
            ultimoResumo = {
                lote, totalTon, qtdCarretas, mediaCarreta, metrics, isApproved,
                dataHora: now.toLocaleString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })
            };
            
            document.getElementById('resumoDataHora').innerText = ultimoResumo.dataHora;
            document.getElementById('resumoNumeroLote').innerText = lote;
            document.getElementById('resumoQuantidade').innerText = totalTon.toFixed(2);
            document.getElementById('resumoCarretas').innerText = qtdCarretas;
            document.getElementById('resumoMedia').innerText = mediaCarreta;
            document.getElementById('resumoCusto').innerText = metrics.custo.toFixed(2);
            
            const badge = document.getElementById('statusBadge');
            if(isApproved) {
                badge.innerText = '‚úÖ APROVADO';
                badge.className = 'dashboard-status-badge approved';
            } else {
                badge.innerText = '‚ùå REPROVADO';
                badge.className = 'dashboard-status-badge rejected';
            }
            
            document.getElementById('resumoPCS').innerText = metrics.pcs.toFixed(0);
            document.getElementById('resumoStatusPCS').innerText = pcsOk ? '‚úì Conforme' : '‚úó N√£o Conforme';
            const pcsCard = document.getElementById('pcsCard');
            pcsCard.className = pcsOk ? 'quality-card ok' : 'quality-card error';
            document.getElementById('pcsBadge').className = pcsOk ? 'quality-badge ok' : 'quality-badge error';
            document.getElementById('pcsBadge').innerText = pcsOk ? '‚úì' : '‚úó';
            
            document.getElementById('resumoCinza').innerText = metrics.cinza.toFixed(2);
            document.getElementById('resumoStatusCinza').innerText = czOk ? '‚úì Conforme' : '‚úó N√£o Conforme';
            const cinzaCard = document.getElementById('cinzaCard');
            cinzaCard.className = czOk ? 'quality-card ok' : 'quality-card error';
            document.getElementById('cinzaBadge').className = czOk ? 'quality-badge ok' : 'quality-badge error';
            document.getElementById('cinzaBadge').innerText = czOk ? '‚úì' : '‚úó';
            
            document.getElementById('resumoUmidade').innerText = metrics.umid.toFixed(2);
            document.getElementById('resumoStatusUmidade').innerText = umidOk ? '‚úì Conforme' : '‚úó N√£o Conforme';
            const umidadeCard = document.getElementById('umidadeCard');
            umidadeCard.className = umidOk ? 'quality-card ok' : 'quality-card error';
            document.getElementById('umidadeBadge').className = umidOk ? 'quality-badge ok' : 'quality-badge error';
            document.getElementById('umidadeBadge').innerText = umidOk ? '‚úì' : '‚úó';
            
            document.getElementById('resumoEnxofre').innerText = metrics.enxofre.toFixed(2);
            document.getElementById('resumoStatusEnxofre').innerText = enxOk ? '‚úì Conforme' : '‚úó N√£o Conforme';
            const enxofreCard = document.getElementById('enxofreCard');
            enxofreCard.className = enxOk ? 'quality-card ok' : 'quality-card error';
            document.getElementById('enxofreBadge').className = enxOk ? 'quality-badge ok' : 'quality-badge error';
            document.getElementById('enxofreBadge').innerText = enxOk ? '‚úì' : '‚úó';
            
            if(isApproved) {
                document.getElementById('finalStatusIcon').innerText = '‚úÖ';
                document.getElementById('resumoQualidade').innerText = 'LOTE APROVADO';
            } else {
                document.getElementById('finalStatusIcon').innerText = '‚ùå';
                document.getElementById('resumoQualidade').innerText = 'LOTE REPROVADO';
            }
            
            const card = document.getElementById('resumoLoteCard');
            card.classList.add('show');
        }

        function imprimirResumo() {
            window.print();
        }

        function fecharResumo() {
            document.getElementById('resumoLoteCard').classList.remove('show');
        }

        function exportarJSON() {
            if(!ultimoResumo) {
                alert('Nenhum resumo dispon√≠vel para exportar. Salve um lote primeiro.');
                return;
            }

            const jsonData = {
                lote: ultimoResumo.lote,
                dataHora: ultimoResumo.dataHora,
                quantidadeLote: ultimoResumo.totalTon,
                quantidadeCarretas: ultimoResumo.qtdCarretas,
                mediaCarreta: ultimoResumo.mediaCarreta,
                qualidade: {
                    status: ultimoResumo.isApproved ? 'APROVADO' : 'REPROVADO',
                    pcs: parseFloat(ultimoResumo.metrics.pcs.toFixed(0)),
                    cinza: parseFloat(ultimoResumo.metrics.cinza.toFixed(2)),
                    umidade: parseFloat(ultimoResumo.metrics.umid.toFixed(2)),
                    enxofre: parseFloat(ultimoResumo.metrics.enxofre.toFixed(2))
                }
            };

            const dataStr = JSON.stringify(jsonData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `resumo_lote_${ultimoResumo.lote}_${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function gerarOC() {
            if(!ultimoResumo) return;
            
            const win = window.open('', '_blank');
            let materiaisHTML = '';
            
            materials.forEach((mat, idx) => {
                if (percentages[idx] > 0) {
                    const qtdTon = (ultimoResumo.totalTon * percentages[idx] / 100).toFixed(2);
                    materiaisHTML += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; text-align: left;">${mat.nome}</td>
                            <td style="padding: 12px; text-align: center; font-weight: bold;">${percentages[idx].toFixed(1)}%</td>
                            <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">${qtdTon} t</td>
                        </tr>
                    `;
                }
            });

            // Adicionar informa√ß√µes da mistura se estiver vis√≠vel
            let misturaHTML = '';
            if (misturaVisivel) {
                const loteInfo = document.getElementById('misturaLoteInfo').value;
                const bonitoCargas = document.getElementById('misturaBonitoCargas').value;
                const bonitoConchadas = document.getElementById('misturaBonitoConchadas').value;
                const finosCargas = document.getElementById('misturaFinosCargas').value;
                const finosConchadas = document.getElementById('misturaFinosConchadas').value;
                const especialConchadas = document.getElementById('misturaEspecialConchadas').value;
                const misturaObs = document.getElementById('misturaObs').value;
                
                misturaHTML = `
                    <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border: 2px solid #e67e22; border-radius: 8px;">
                        <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #e67e22; padding-bottom: 10px;">INSTRU√á√ïES DE MISTURA</h3>
                        
                        <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 6px;">
                            <strong style="color: #2c3e50;">1¬∫ Lote:</strong> ${loteInfo}
                        </div>
                        
                        <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 6px;">
                            <strong style="color: #2c3e50;">Carv√£o Bonito:</strong> ${bonitoCargas}<br>
                            <span style="margin-left: 20px; color: #555;">‚Üí Usar <strong>${bonitoConchadas}</strong> conchadas de especial</span>
                        </div>
                        
                        <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 6px;">
                            <strong style="color: #2c3e50;">Mistura de Finos + Especial:</strong> ${finosCargas}<br>
                            <span style="margin-left: 20px; color: #555;">‚Üí Usar <strong>${finosConchadas}</strong> de Finos e <strong>${especialConchadas}</strong> de Especial por carreta</span>
                        </div>
                        ${misturaObs ? `
                        <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                            <strong style="color: #2c3e50;">OBSERVA√á√ïES:</strong> <span style="font-weight: bold;">${misturaObs}</span>
                        </div>
                        ` : ''}

                    </div>
                `;
            }

            win.document.write(`
                <html>
                <head>
                    <title>OC - Operador de Carregadeira - Lote ${ultimoResumo.lote}</title>
                    <style>
                        body { font-family: sans-serif; padding: 40px; color: #333; }
                        .oc-container { max-width: 800px; margin: auto; border: 2px solid #333; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #f4f4f4; padding: 12px; border-bottom: 2px solid #333; }
                        .footer { margin-top: 40px; text-align: center; font-size: 0.9em; color: #666; }
                        .print-btn { background: #333; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-bottom: 20px; }
                        @media print { .print-btn { display: none; } }
                    
        /* GLOBAL BOLD */
        * { font-weight: bold !important; }
        
        /* PAINEL DE MISTURA v19 - Com suporte a modo escuro e layout profissional */
        .mistura-container { 
            margin-bottom: 20px; 
            background: var(--card-bg);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        .mistura-container.hidden { display: none; }
        
        .mistura-header {
            color: var(--text-color);
            font-size: 1.3em;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 10px;
            display: flex;
            justify-content: center;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .mistura-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .mistura-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mistura-item label { 
            font-size: 0.95em; 
            white-space: nowrap;
            color: var(--text-color);
            font-weight: 600;
        }
        .mistura-item input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            width: 100px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .mistura-item input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
        }
        
        .toggle-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .btn-toggle-mistura {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-toggle-mistura:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* Ajuste OC para incluir mistura */
        #ocContent .mistura-oc-info {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #000;
        }

    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir Ordem</button>
                    <div class="oc-container">
                        <div class="header">
                            <h1>ORDEM DE CARREGAMENTO (OC)</h1>
                            <p><b>Lote:</b> ${ultimoResumo.lote} | <b>Data:</b> ${ultimoResumo.dataHora}</p>
                            <div style="display: flex; justify-content: space-around; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-top: 15px;">
                                <div><b>Volume Total:</b><br>${ultimoResumo.totalTon} Toneladas</div>
                                <div><b>Qtd. Carretas:</b><br>${ultimoResumo.qtdCarretas}</div>
                                <div><b>M√©dia/Carreta:</b><br>${ultimoResumo.mediaCarreta} t</div>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Material</th>
                                    <th>Porcentagem (%)</th>
                                    <th>Quantidade (Ton)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${materiaisHTML}
                            </tbody>
                        </table>
                        ${misturaHTML}
                        <div class="footer">
                            <p>________________________________________________<br>Assinatura do Respons√°vel</p>
                            <p>Documento gerado pelo Sistema de Blends CCL</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            win.document.close();
        }

        async function gerarLinkCompartilhamento() {
            try {
                const userData = btoa(unescape(encodeURIComponent(JSON.stringify(users))));
                
                // Pegar o conte√∫do completo do HTML atual
                const htmlContent = document.documentElement.outerHTML;
                
                // Criar um "Link Execut√°vel" (Data URL) que cont√©m o programa INTEIRO + os usu√°rios
                // Isso permite que o link abra o programa em qualquer navegador sem precisar do arquivo local
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    // Como arquivos locais (file://) n√£o podem ser abertos por links externos (WhatsApp),
                    // a solu√ß√£o definitiva √© o C√ìDIGO DE ACESSO que sincroniza os dados instantaneamente.
                    
                    const message = `Sincroniza√ß√£o Gerador de Blends\n\nCopie o c√≥digo abaixo e use o bot√£o "üì≤ Sincronizar" na tela de login do App:\n\n${userData}`;
                    
                    if (navigator.share && /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        try {
                            await navigator.share({
                                title: 'Sincronizar Gerador de Blends',
                                text: message
                            });
                        } catch (shareErr) {
                            prompt('Copie o C√ìDIGO abaixo e envie pelo WhatsApp:', userData);
                        }
                    } else {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = userData;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        alert('C√ìDIGO DE ACESSO COPIADO!\n\nInstru√ß√µes para o colega:\n1. Abrir o programa.\n2. Na tela de login, clicar em "üì≤ Sincronizar".\n3. Colar este c√≥digo.');
                    }
                };
                reader.readAsDataURL(blob);
                
            } catch (err) {
                alert('Erro ao gerar link execut√°vel.');
            }
        }

        function importarCodigoSincronizacao() {
            const code = prompt('Cole aqui o C√ìDIGO DE SINCRONIZA√á√ÉO enviado pelo seu colega:');
            if (code) {
                try {
                    const decodedData = decodeURIComponent(escape(atob(code)));
                    const importedUsers = JSON.parse(decodedData);
                    if (Array.isArray(importedUsers)) {
                        importedUsers.forEach(impUser => {
                            if (!users.find(u => u.username === impUser.username)) {
                                users.push(impUser);
                            }
                        });
                        saveUsers();
                        alert('‚úÖ USU√ÅRIOS SINCRONIZADOS COM SUCESSO!\nAgora voc√™ j√° pode fazer login com seu usu√°rio e senha.');
                    }
                } catch (e) {
                    alert('‚ùå C√ìDIGO INV√ÅLIDO!\nCertifique-se de copiar o c√≥digo exatamente como foi enviado.');
                }
            }
        }

        function checkSync() {
            const urlParams = new URLSearchParams(window.location.search);
            const syncData = urlParams.get('sync');
            if (syncData) {
                try {
                    const decodedData = decodeURIComponent(escape(atob(syncData)));
                    const importedUsers = JSON.parse(decodedData);
                    if (Array.isArray(importedUsers)) {
                        importedUsers.forEach(impUser => {
                            if (!users.find(u => u.username === impUser.username)) {
                                users.push(impUser);
                            }
                        });
                        saveUsers();
                        // Limpar a URL ap√≥s sincronizar
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert('Usu√°rios sincronizados via link com sucesso!');
                    }
                } catch (e) {
                    console.error('Erro na sincroniza√ß√£o via link');
                }
            }
        }

        function showPDFButton() {
            const pdfBtn = document.getElementById('pdfButton');
            if(pdfBtn) pdfBtn.style.display = 'inline-block';
        }

        function generatePDF() {
            const now = new Date();
            const lote = document.getElementById('numeroLote').value || 'S/ID';
            const totalTon = parseFloat(document.getElementById('totalToneladas').value) || 1000;
            const m = calculateMetrics(percentages, totalTon);

            const pcsOk = m.pcs >= 4500;
            const czOk = m.cinza <= 44;
            const umidOk = m.umid <= 10;
            const enxOk = m.enxofre <= 2.30;
            const isOk = pcsOk && czOk && umidOk && enxOk;

            const dia = String(now.getDate()).padStart(2, '0');
            const mes = String(now.getMonth() + 1).padStart(2, '0');
            const ano = now.getFullYear();
            const horas = String(now.getHours()).padStart(2, '0');
            const minutos = String(now.getMinutes()).padStart(2, '0');
            const segundos = String(now.getSeconds()).padStart(2, '0');
            const dataHora = `${dia}/${mes}/${ano} ${horas}:${minutos}:${segundos}`;

            let materiaisHTML = '';
            materials.forEach((mat, idx) => {
                if (percentages[idx] > 0) {
                    const qtdTon = (totalTon * percentages[idx] / 100).toFixed(2);
                    materiaisHTML += `
                        <tr>
                            <td>${mat.nome}</td>
                            <td class="text-center">${percentages[idx].toFixed(1)}%</td>
                            <td class="text-center">${qtdTon}</td>
                        </tr>
                    `;
                }
            });

            const container = document.getElementById('pdf-export-container');
            
            container.innerHTML = `
                <div class="pdf-page">
                    <div class="pdf-header">
                        <div class="pdf-header-left">
                            <img src="upload/pasted_file_eJuot8_LogoCCL1400145001Branco.png" alt="Logo">
                            <div>
                                <h2 class="pdf-header-title">RELAT√ìRIO DE BLEND</h2>
                                <p class="pdf-header-subtitle">An√°lise T√©cnica de Combust√≠veis e Res√≠duos</p>
                            </div>
                        </div>
                        <div class="pdf-header-right">
                            Lote: <b>${lote}</b><br>${dataHora}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-left: 5px solid #1e3a5f;">
                        <div style="font-size: 10pt; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 5px;">Data e Hora de Gera√ß√£o</div>
                        <div style="font-size: 14pt; font-weight: bold; color: #1e3a5f;">${dataHora}</div>
                    </div>

                    <div class="pdf-section-header">MATERIAIS UTILIZADOS NO BLEND</div>

                    <table class="pdf-table">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Participa√ß√£o (%)</th>
                                <th>Quantidade (ton)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${materiaisHTML}
                        </tbody>
                    </table>

                    <div class="pdf-section-header">RESULTADO FINAL DA QUALIDADE DO LOTE</div>

                    <div class="pdf-results-grid">
                        <div class="pdf-result-box">
                            <div class="pdf-result-label">Poder Cal√≥rico (PCS)</div>
                            <div class="pdf-result-value">${m.pcs.toFixed(0)} kcal/kg</div>
                            <div class="pdf-result-status">Ref: >= 4500 kcal</div>
                            <div class="pdf-status-badge ${pcsOk ? 'pdf-status-ok' : 'pdf-status-error'}">
                                ${pcsOk ? 'Conforme' : 'N√£o Conforme'}
                            </div>
                        </div>
                        <div class="pdf-result-box">
                            <div class="pdf-result-label">Teor de Cinzas</div>
                            <div class="pdf-result-value">${m.cinza.toFixed(2)}%</div>
                            <div class="pdf-result-status">Ref: <= 44%</div>
                            <div class="pdf-status-badge ${czOk ? 'pdf-status-ok' : 'pdf-status-error'}">
                                ${czOk ? 'Conforme' : 'N√£o Conforme'}
                            </div>
                        </div>
                        <div class="pdf-result-box">
                            <div class="pdf-result-label">Umidade</div>
                            <div class="pdf-result-value">${m.umid.toFixed(2)}%</div>
                            <div class="pdf-result-status">Ref: <= 10%</div>
                            <div class="pdf-status-badge ${umidOk ? 'pdf-status-ok' : 'pdf-status-error'}">
                                ${umidOk ? 'Conforme' : 'N√£o Conforme'}
                            </div>
                        </div>
                        <div class="pdf-result-box">
                            <div class="pdf-result-label">Enxofre</div>
                            <div class="pdf-result-value">${m.enxofre.toFixed(2)}%</div>
                            <div class="pdf-result-status">Ref: <= 2.30%</div>
                            <div class="pdf-status-badge ${enxOk ? 'pdf-status-ok' : 'pdf-status-error'}">
                                ${enxOk ? 'Conforme' : 'N√£o Conforme'}
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px; padding: 20px; border-radius: 5px; background-color: ${isOk ? '#d4edda' : '#f8d7da'}; color: ${isOk ? '#155724' : '#721c24'}; font-size: 16pt; font-weight: bold;">
                        ${isOk ? '‚úÖ LOTE APROVADO' : '‚ùå LOTE REPROVADO'}
                    </div>

                    <div class="pdf-footer">
                        Documento gerado automaticamente pelo Sistema de Gera√ß√£o de Blends de Cinzas v2.0
                    </div>
                </div>
            `;

            const opt = {
                margin: [10, 10, 10, 10],
                filename: `Relatorio_Blend_${lote}_${now.getTime()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, allowTaint: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(container).save();
        }

        
        function clearHistory() {
            if (confirm('Tem certeza que deseja excluir TODO o hist√≥rico salvo? Esta a√ß√£o n√£o pode ser desfeita.')) {
                history = [];
                saveData();
                openHistory();
                alert('Hist√≥rico exclu√≠do com sucesso!');
            }
        }

        function deleteHistoryItem(idx) {
            if (confirm('Tem certeza que deseja excluir este item do hist√≥rico?')) {
                history.splice(idx, 1);
                saveData();
                openHistory();
            }
        }

        function openHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = history.length === 0 ? '<p>Nenhum hist√≥rico encontrado.</p>' : '';
            history.forEach((item, idx) => {
                list.innerHTML += `
                    <div class="history-item">
                        <div><b>${item.lote}</b><br><small>${item.data} | PCS: ${item.metrics.pcs.toFixed(0)}</small></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-primary" onclick="loadLot(${idx})" style="padding:5px 10px">Carregar</button>
                            <button class="btn-danger" onclick="deleteHistoryItem(${idx})" style="padding:5px 10px">‚ùå Excluir</button>
                        </div>
                    </div>`;
            });
            document.getElementById('historyModal').style.display = 'block';
        }

        function loadLot(idx) {
            const item = history[idx];
            document.getElementById('numeroLote').value = item.lote;
            document.getElementById('totalToneladas').value = item.totalTon;
            percentages = [...item.percentages];
            renderMaterials();
            updateResults();
            document.getElementById('historyModal').style.display = 'none';
        }

        function toggleAutoCalculate() {
            autoCalculateEnabled = !autoCalculateEnabled;
            const btn = document.getElementById('btnToggleAutoCalc');
            btn.innerText = autoCalculateEnabled ? '‚ö° C√°lculo: ON' : '‚ö™ C√°lculo: OFF';
            btn.style.background = autoCalculateEnabled ? 'var(--accent)' : '#95a5a6';
            if (autoCalculateEnabled) updateCalculatedFields();
        }

        function updateCalculatedFields() {
            if (!autoCalculateEnabled) return;
            // Restri√ß√£o de Administrador para c√°lculo autom√°tico
            if (!currentUser.isAdmin) return;
            
            const nome = document.getElementById('editNome').value;
            const cinza = parseFloat(document.getElementById('editCinzas').value) || 0;
            
            let enxofre = null;
            let pcs = null;

            if (nome === "Carv√£o bonito") {
                enxofre = 0.025 * cinza + 1.39;
                pcs = -86.41 * cinza + 8334.7;
            } else if (nome === "Finos Bonito") {
                enxofre = 0.025 * cinza + 1.39;
                pcs = -86.41 * cinza + 8334.7;
            } else if (nome === "Carv√£o Barro Branco") {
                enxofre = 0.031 * cinza + 0.85;
                pcs = -93.006 * cinza + 8581.5;
            } else if (nome === "Finos Barro Branco") {
                enxofre = 0.031 * cinza + 0.83;
                pcs = -93.006 * cinza + 8581.5;
            }

            if (enxofre !== null) {
                document.getElementById('editEnxofre').value = enxofre.toFixed(2);
                document.getElementById('editPcs').value = Math.round(pcs);
            }
        }

        function openEditModal(idx) {
            currentEditIndex = idx;
            const m = materials[idx];
            document.getElementById('editNome').value = m.nome;
            document.getElementById('editPcs').value = m.pcs;
            document.getElementById('editCinzas').value = m.cinzas;
            document.getElementById('editUmidade').value = m.umidade;
            document.getElementById('editEnxofre').value = m.enxofre;
            document.getElementById('editEstoque').value = m.estoque;
            document.getElementById('editCustoFixo').value = m.custoFixo || 0;
            document.getElementById('editCustoVariavel').value = m.custoVariavel || 0;
            
            // Adicionar event listener para c√°lculo autom√°tico
            const cinzaInput = document.getElementById('editCinzas');
            cinzaInput.removeEventListener('input', updateCalculatedFields);
            cinzaInput.addEventListener('input', updateCalculatedFields);
            
            // Controle de visibilidade do bot√£o de c√°lculo autom√°tico (apenas para Admins)
            const btnToggle = document.getElementById('btnToggleAutoCalc');
            if (currentUser.isAdmin) {
                btnToggle.style.display = 'inline-block';
            } else {
                btnToggle.style.display = 'none';
                autoCalculateEnabled = false; // Garante que est√° desligado para n√£o-admins
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

        function saveMaterialEdit() {
            const m = materials[currentEditIndex];
            m.nome = document.getElementById('editNome').value;
            m.pcs = parseFloat(document.getElementById('editPcs').value);
            m.cinzas = parseFloat(document.getElementById('editCinzas').value);
            m.umidade = parseFloat(document.getElementById('editUmidade').value);
            m.enxofre = parseFloat(document.getElementById('editEnxofre').value);
            m.estoque = parseFloat(document.getElementById('editEstoque').value);
            m.custoFixo = parseFloat(document.getElementById('editCustoFixo').value) || 0;
            m.custoVariavel = parseFloat(document.getElementById('editCustoVariavel').value) || 0;
            closeEditModal();
            renderMaterials();
            updateResults();
            saveData();
        }

        function openStockManager() {
            const list = document.getElementById('stockList');
            list.innerHTML = '';
            materials.forEach((m, idx) => {
                list.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center">
                        <span>${m.nome}</span>
                        <input type="number" value="${m.estoque}" onchange="updateSingleStock(${idx}, this.value)" style="width:100px">
                    </div>`;
            });
            document.getElementById('stockModal').style.display = 'block';
        }

        function updateSingleStock(idx, val) {
            materials[idx].estoque = parseFloat(val);
            renderMaterials();
            updateResults();
            saveData();
        }

        function saveData() {
            localStorage.setItem('blendDataPro', JSON.stringify({
                misturaVisivel: typeof misturaVisivel !== 'undefined' ? misturaVisivel : true,
                misturaLoteInfo: document.getElementById('misturaLoteInfo').value,
                misturaBonitoCargas: document.getElementById('misturaBonitoCargas').value,
                misturaBonitoConchadas: document.getElementById('misturaBonitoConchadas').value,
                misturaFinosCargas: document.getElementById('misturaFinosCargas').value,
                misturaFinosConchadas: document.getElementById('misturaFinosConchadas').value,
                misturaEspecialConchadas: document.getElementById('misturaEspecialConchadas').value,
                misturaObs: document.getElementById('misturaObs').value,
                materials, percentages, history, theme: currentTheme,
                totalTon: document.getElementById('totalToneladas').value,
                pesoCarreta: document.getElementById('pesoCarreta').value,
                metaPcsMin: document.getElementById('metaPcsMin').value,
                numeroLote: document.getElementById('numeroLote').value,
                ocultarZerados: ocultarZerados
            }));
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        console.log('Service Worker registrado com sucesso:', reg);
                    })
                    .catch(err => {
                        console.log('Erro ao registrar Service Worker:', err);
                    });
            });
        }

        window.onload = initAuth;
    </script>
</body>
</html>
